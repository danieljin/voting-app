<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel='stylesheet' type='text/css' href='css/main.css'>
    <link rel='stylesheet' type='text/css' href='vendor/semantic/semantic.min.css'>
    <script src='/socket.io/socket.io.js'></script>
    <script src='js/jquery-2.1.3.min.js'></script>
    <script src='vendor/semantic/semantic.min.js'></script>
    <script>
      $()
      var socket = io();

      socket.on('roominfo', function(data){
        $("#loading").fadeOut("slow");
        var numberOfUsers = $('#container.user').length;
        for (var i = 0, len = data.userCount - numberOfUsers; i < len; i++) {
          $('#hidden .user').first().clone().appendTo('#container').show();
        }
        $('#roomNumber').html(data.number);
        if (data.voters.length > 0) {
          for (var i = 0, len = data.voters.length; i < len; i++) {
            addHiddenVote(data.voters[i]);
          }
        }
      });
      socket.on('joined', function(){
        $('#hidden .user').first().clone().appendTo('#container').fadeIn();
      });
      socket.on('left', function(data){
        removeVoter(data.userId);
      });
      socket.on('voted', function(data){
        addHiddenVote(data.userId);
      });

      $(function() {
        $('.button').click(function(e){
          socket.emit('addVote', $(this).html());
          $(this).addClass('active').siblings().removeClass('active');
        });
      });

      function removeVoter(userId) {
        $('#container .user').each(function(index){
          if ($(this).data('userId') == userId){
            $(this).remove();
            return;
          } else {
            if ($(this).length - 1 == index){
              $('#container .user:not(.voted)').last().remove();
            }
          }
        });
      }

      // this can be improved to not loop through unvoted cards
      function addHiddenVote(userId) {
        $('#container .user').each(function(index){
          if ($(this).data('userId') == userId){
            return;
          } else {
            if ($(this).length - 1 == index){
              $('#container .user:not(.voted)').first().data('userId', userId).addClass('voted');
            }
          }
        });
      }
    </script>
  </head>
  <body bgcolor='#242624'>
  <div class='ui piled segment'>
    <div class='ui teal dividing header'>
      <i class='dashboard icon'></i>
      <div class='content'>
        Voting App
        <div class='sub header'>danielkjin</div>
      </div>
    </div>
  </div>
  <div id='loading'>
    <div class="ui active dimmer">
      <div class="ui indeterminate text active loader">
        Connecting...
      </div>
    </div>
  </div>
  <div id='main'>
    <div class='ui attached tertiary segment'>  <a id='ribbon' class='ui ribbon label teal'>#<span id="roomNumber"></span></a>
      <div id='container'>
      </div>
    </div>
    <div id='buttons' class='ui segment'>
      <div class="ui buttons">
        <div class="ui teal button">0</div>
        <div class="ui teal button">1</div>
        <div class="ui teal button">2</div>
        <div class="ui teal button">3</div>
        <div class="ui teal button">5</div>
        <div class="ui teal button">8</div>
        <div class="ui teal button">13</div>
        <div class="ui teal button">21</div>
        <div class="ui teal button">34</div>
        <div class="ui teal button">55</div>
        <div class="ui teal button">89</div>
        <div class="ui teal button">?</div>
      </div>

    </div>
  </div>
  <div id='hidden'>
    <div class='user ui compact stacked segment' style='display:none;'>
      &nbsp;
    </div>
  </div>
  </body>
</html>
