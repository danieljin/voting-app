<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel='stylesheet' type='text/css' href='css/main.css'>
    <link rel='stylesheet' type='text/css' href='vendor/semantic/semantic.min.css'>
    <script src='/socket.io/socket.io.js'></script>
    <script src='js/jquery-2.0.3.min.js'></script>
    <script src='vendor/semantic/semantic.min.js'></script>
    <script>
      var socket = io();

      socket.on('roominfo', function(data){
        $("#loading").fadeOut("slow");
        for (var i = 0, len = data.userCount; i < len; i++) {
          if ( i == 0 ) {
            $('#hidden .usershape').first().clone().addClass('me').appendTo('#container').show();
          } else {
            $('#hidden .usershape').first().clone().appendTo('#container').show();
          }
        }
        $('#roomNumber').html(data.number);
        if (data.voters.length > 0) {
          for (var i = 0, len = data.voters.length; i < len; i++) {
            addHiddenVote(data.voters[i]);
          }
        }
      });
      socket.on('joined', function(){
        $('#hidden .usershape').first().clone().appendTo('#container').fadeIn();
        hideVotes();
      });
      socket.on('left', function(data){
        removeVoter(data.userId);
      });
      socket.on('voted', function(data){
        addHiddenVote(data.userId);
      });
      socket.on('removeVote', function(data){
        removeVote(data.userId);
      });
      socket.on('removeVotes', function(data){
        removeVotes();
      });
      socket.on('reveal', function(data){
        revealVotes(data.votes);
      });

      $(function() {
        $('.item').click(function(e){
          e.stopImmediatePropagation();
          socket.emit('addVote', $(this).html());
          $(this).addClass('active').siblings().removeClass('active');
        });
        $('#reset').click(function(e){
          socket.emit('reset');
        });
        $('#reveal').click(function(e){
          socket.emit('reveal');
        });
        $('i.reply').click(function(){
          document.location.href='/home';
        });
      });

      function removeVoter(userId) {
        $('#container .usershape').each(function(index){
          if ($(this).data('userId') == userId){
            $(this).remove();
            return false;
          } else {
            if ($('#container .usershape').length - 1 == index){
              $('#container .usershape:not(.voted):not(.me)').last().remove();
            }
          }
        });
      }

      // this can be improved to not loop through unvoted cards
      function addHiddenVote(userId) {
        if (socket.id == userId){
          $('.usershape.me').data('userId', userId).addClass('voted');
          flip($('.usershape.me'), 'back');
          $('.usershape.me .back a').removeClass('hidden');
          $('.usershape.me .close').click(function(e){
            socket.emit('removeVote');
          });
          return false;
        } else {
          $('#container .usershape').each(function(index){
            if ($(this).data('userId') == userId){
              return false;
            } else {
              if ($('#container .usershape').length - 1 == index){
                var chosenOne = $('#container .usershape:not(.voted):not(.me)').first();
                chosenOne.data('userId', userId).addClass('voted');
                flip(chosenOne, 'back');
              }
            }
          });
        }
      }

      function removeVote(userId) {
        $('#container .usershape').each(function(index){
          if ($(this).data('userId') == userId){
            $(this).removeData('userId').removeClass('voted');
            flip(this, 'front');
            if (socket.id == userId) {
              $(this).find('a').addClass('hidden');
              $('#buttons .item').removeClass('active');
            }
          }
        });
      }

      function removeVotes() {
        $('#container .usershape').each(function(index){
          $(this).removeData('userId').removeClass('voted').find('h3').html('');
          flip(this, 'front');
          $('.item').removeClass('disabled active');
        });
      }

      function hideVotes() {
        $('#container .usershape').each(function(index){
          $(this).find('h3').html('');
          if ($(this).hasClass('voted')){
            flip(this, 'back');
          } else {
            flip(this, 'front');
          }
          $('.item').removeClass('disabled active');
        });
      }

      function revealVotes(votes) {
        for (var i = votes.length - 1; i >= 0; i--) {
          $('.usershape:data(userId)').each(function(){
            if ($(this).data('userId') == votes[i].id){
              $(this).find('h3').html(votes[i].vote);
              flip(this, 'front');
            }
          });
        };
        $('.item').addClass('disabled');
      }

      function flip(selector, side){
        if (!$(selector).find('.active').hasClass(side)){
          $(selector).find('.'+side).show().addClass('active').siblings().hide().removeClass('active');
        }
      }

      // Function from David Walsh: http://davidwalsh.name/css-animation-callback
      function whichTransitionEvent(){
        var t,
            el = document.createElement("fakeelement");

        var transitions = {
          "transition"      : "transitionend",
          "OTransition"     : "oTransitionEnd",
          "MozTransition"   : "transitionend",
          "WebkitTransition": "webkitTransitionEnd"
        }

        for (t in transitions){
          if (el.style[t] !== undefined){
            return transitions[t];
          }
        }
      }

      var transitionEvent = whichTransitionEvent();
    </script>
  </head>
  <body bgcolor='#242624'>
  <div class='ui piled segment'>
    <div class='ui teal dividing header'>
      <i class='dashboard icon'></i>
      <div class='content'>
        Voting App
        <div class='sub header'>danielkjin</div>
      </div>
    </div>
  </div>
  <div id='loading'>
    <div class="ui active dimmer">
      <div class="ui indeterminate text active loader">
        Connecting...
      </div>
    </div>
  </div>
  <i class="big reply icon"></i>
  <div id='main'>
    <div class='ui tertiary segment'>  <a id='ribbon' class='ui ribbon label teal'>#<span id="roomNumber"></span></a>
      <div id='container'>
      </div>
    </div>
    <div id='buttons' class="ui twelve item teal menu">
      <a class="item">0</a>
      <a class="item">1</a>
      <a class="item">2</a>
      <a class="item">3</a>
      <a class="item">5</a>
      <a class="item">8</a>
      <a class="item">13</a>
      <a class="item">21</a>
      <a class="item">34</a>
      <a class="item">55</a>
      <a class="item">89</a>
      <a class="item">?</a>
    </div>
    <div id="reset" class="ui red basic labeled icon button">
      <i class="retweet icon"></i>
      Reset
    </div>
    <div id="reveal" class="ui teal basic labeled icon button">
      <i class="arrow circle up icon"></i>
      Reveal
    </div>
  </div>
  <div id='hidden'>
    <div class="usershape ui text shape" style='display:none;'>
      <div class="sides">
        <div class="active ui header side front">
          <div class='user ui compact stacked segment'><h3 class="ui header"></h3></div>
        </div>
        <div class="ui header side back">
          <div class='user ui compact stacked segment red'>
            <a class="ui right corner label hidden">
              <i class="close icon"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  </body>
</html>
